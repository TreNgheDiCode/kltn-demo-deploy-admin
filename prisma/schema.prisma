generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ENUMS
enum Gender {
  MALE
  FEMALE
}

enum GradeType {
  GPA
  CGPA
}

enum CertificateType {
  IELTS
  TOEFL
}

enum DegreeType {
  HIGHSCHOOL
  UNIVERSITY
}

enum StudentStatus {
  STUDYING
  DROPPED
  AWAITING
  APPROVED
}

enum ProfileStatus {
  ONLINE
  OFFLINE
  IDLE
  BUSY
  INVISIBLE
}

enum PostStatus {
  PUBLIC
  PRIVATE
  FRIENDS
  EXCEPT
}

enum SocialType {
  YOUTUBE
  FACEBOOK
  INSTAGRAM
  TIKTOK
  TWITCH
  TWITTER
  PORTFOLLIO
}

enum NewsType {
  ANNOUNCEMENT // Thông báo từ trường hoặc từ phía công ty
  EVENT // Sự kiện
  BLOG // Các bài viết chung chung (dạng như tham quan trường hoặc hướng dẫn gì đó)
}

enum Country {
  AUSTRALIA
  KOREA
  CANADA
}

enum ContactTitle {
  FEEDBACK
  SYSTEM
  REFUND
  BILLING
  SCHOLARSHIP
  PROCEDURE
}

// MODELS
model Account {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Account
  email         String    @unique
  emailVerified DateTime?
  password      String
  name          String

  // Profile
  dob          DateTime
  gender       Gender
  phoneNumber  String
  idCardNumber String   @unique
  address      String

  image String?

  isLocked Boolean @default(false)

  // Two Factor Authentication
  isTwoFactorEnabled    Boolean                @default(false)
  twoFactorConfirmation TwoFactorConfirmation?

  // User Profile
  student Student?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model VerificationToken {
  id      String   @id @default(auto()) @map("_id") @db.ObjectId
  email   String
  token   String   @unique
  expires DateTime

  createdAt DateTime @default(now())

  @@unique([email, token])
}

model PasswordResetToken {
  id      String   @id @default(auto()) @map("_id") @db.ObjectId
  email   String
  token   String   @unique
  expires DateTime

  createdAt DateTime @default(now())

  @@unique([email, token])
}

model TwoFactorToken {
  id      String   @id @default(auto()) @map("_id") @db.ObjectId
  email   String
  token   String   @unique
  expires DateTime

  createdAt DateTime @default(now())

  @@unique([email, token])
}

model TwoFactorConfirmation {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  accountId String  @unique @db.ObjectId
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model School {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  logo        String
  background  String
  name        String  @unique
  short       String?
  description String?
  history     String?
  color       String
  isPublished Boolean @default(false)
  country     Country

  students Student[]

  locations    SchoolLocation[]
  programs     SchoolProgram[]
  galleries    SchoolGallery[]
  scholarships SchoolScholarship[]
  news         News[]
  contacts     Contact[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SchoolScholarship {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String
  cover       String?
  isPublished Boolean @default(false)

  schoolId String @db.ObjectId
  school   School @relation(fields: [schoolId], references: [id])

  owners StudentSchoolScholarship[]
  images SchoolScholarshipImage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, name])
}

model SchoolScholarshipImage {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  url String

  scholarshipId String            @db.ObjectId
  scholarship   SchoolScholarship @relation(fields: [scholarshipId], references: [id], onDelete: Cascade)
}

model StudentSchoolScholarship {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  studentId String  @unique @db.ObjectId
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  scholarshipId String            @db.ObjectId
  scholarship   SchoolScholarship @relation(fields: [scholarshipId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, scholarshipId])
}

model SchoolGallery {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?

  images SchoolGalleryImage[]

  schoolId String @db.ObjectId
  school   School @relation(fields: [schoolId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model SchoolGalleryImage {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  url String

  galleryId String        @db.ObjectId
  gallery   SchoolGallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)
}

model SchoolLocation {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  cover   String?
  name    String  @unique
  address String  @unique
  isMain  Boolean @default(false)

  images   SchoolLocationImage[]
  contacts SchoolLocationContact[]
  students StudentSchoolLocation[]

  schoolId String @db.ObjectId
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SchoolLocationImage {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  url String

  locationId String         @db.ObjectId
  location   SchoolLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
}

model SchoolLocationContact {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  phone String?
  hours String?
  fax   String?
  email String?
  url   String?

  locationId String         @db.ObjectId
  location   SchoolLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SchoolProgram {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String
  cover       String?
  isPublished Boolean @default(false)

  schoolId String @db.ObjectId
  school   School @relation(fields: [schoolId], references: [id])

  studentPrograms StudentSchoolProgram[]
  images          SchoolProgramImage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, name])
}

model SchoolProgramImage {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  url String

  programId String        @db.ObjectId
  program   SchoolProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
}

model StudentSchoolProgram {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  studentId String  @unique @db.ObjectId
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  programId String        @db.ObjectId
  program   SchoolProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, programId])
}

model StudentSchoolLocation {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  studentId String  @unique @db.ObjectId
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  locationId String         @db.ObjectId
  location   SchoolLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, locationId])
}

model Student {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Student code
  studentCode String? @unique

  // Education
  degreeType DegreeType

  certificateType CertificateType
  certificateImg  String

  gradeType  GradeType
  gradeScore Float

  cover String?

  additional String?

  // Student status
  status StudentStatus @default(AWAITING)

  accountId String  @unique @db.ObjectId
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Education
  schoolId String @db.ObjectId
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  profile Profile?

  program     StudentSchoolProgram?
  location    StudentSchoolLocation?
  scholarship StudentSchoolScholarship[]

  notifications      NewsNotification[] @relation("notifications")
  ownedNotifications NewsNotification[] @relation("owns")
  follows            StudentFollow[]    @relation("follows")
  followers          StudentFollow[]    @relation("followers")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Event {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  title String

  hostId String  @unique @db.ObjectId
  host   Profile @relation(fields: [hostId], references: [id], onDelete: Cascade)

  participants EventProfile[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventProfile {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  eventId String @db.ObjectId
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  profileId String  @db.ObjectId
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, profileId])
}

model Profile {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Status
  status ProfileStatus @default(ONLINE)

  studentId String  @unique @db.ObjectId
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Hosted Events
  hostedEvents Event[]

  // Participated Events
  participatedEvents EventProfile[]

  // Feeds
  posts Post[]

  // Biography
  biography ProfileBiography?

  // Friends
  friendRequests ProfileFriend[] @relation("profileOne")
  friendReceived ProfileFriend[] @relation("profileTwo")

  // Groups
  ownedGroups Group[]
  groups      ProfileGroup[]

  // Blogs
  blogs ProfileBlog[]

  // Messages
  // conversations Conversation[]
  // seenMessages Message[] @relation("Seen")
  // sendMessages Message[]

  // Comments
  postComments     PostComment[]
  postCommentLikes PostCommentLike[]

  // Posts liked
  postLikes PostLike[]

  // Posts shared
  postShares PostShare[]

  // Posts saved
  postSaved PostSave[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProfileFriend {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  isActive Boolean @default(false)

  profileIdOne String  @unique @db.ObjectId
  profileOne   Profile @relation("profileOne", fields: [profileIdOne], references: [id], onDelete: Cascade)

  profileIdTwo String  @unique @db.ObjectId
  profileTwo   Profile @relation("profileTwo", fields: [profileIdTwo], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// model Conversation {
//   id String @id @default(auto()) @map("_id") @db.ObjectId

//   name          String?
//   cover String?
//   isGroup       Boolean? @default(false)

// // Owner
//   ownerId String
//   owner   Profile   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

//   messages    Message[]

//   createdAt     DateTime @default(now())
//   updatedAt DateTime @updatedAt
// }

// model Message {
//   id String @id @default(auto()) @map("_id") @db.ObjectId

//   body  String?
//   image String?

//   seenIds String
//   seen    Profile @relation("Seen", fields: [seenIds], references: [id])

//   conversationId String      
//   conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

//   senderId String
//   sender   Profile   @relation(fields: [senderId], references: [id], onDelete: Cascade)

//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt
// }

// model MessageSeen {
//   id String @id @default(auto()) @map("_id") @db.ObjectId

// }

model Area {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  title String @unique

  biographies ProfileBiographyArea[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProfileBiography {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  content String

  profileId String  @unique @db.ObjectId
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  areas   ProfileBiographyArea[]
  socials ProfileBiographySocial[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProfileBiographyArea {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  biographyId String           @db.ObjectId
  biography   ProfileBiography @relation(fields: [biographyId], references: [id], onDelete: Cascade)

  areaId String @db.ObjectId
  area   Area   @relation(fields: [areaId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([biographyId, areaId])
}

model ProfileBiographySocial {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  type SocialType
  href String

  profileBiographyId String           @db.ObjectId
  profileBiography   ProfileBiography @relation(fields: [profileBiographyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([type, href])
  @@index([type])
}

model ProfileBlog {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  title   String
  content String?
  images  ProfileBlogImage[]

  profileId String  @unique @db.ObjectId
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([title])
}

model ProfileBlogImage {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  url String

  profileBlogId String      @db.ObjectId
  profileBlog   ProfileBlog @relation(fields: [profileBlogId], references: [id], onDelete: Cascade)
}

model Post {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  content    String?
  status     PostStatus @default(PUBLIC)
  isArchived Boolean    @default(false)

  profileId String  @db.ObjectId
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  images   PostImage[]
  comments PostComment[]
  likes    PostLike[]
  shares   PostShare[]
  saves    PostSave[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
}

model PostImage {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  url String

  postId String @db.ObjectId
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model PostLike {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  profileId String  @db.ObjectId
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  postId String @db.ObjectId
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([profileId, postId])
}

model PostShare {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  profileId String  @db.ObjectId
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  postId String @db.ObjectId
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([profileId, postId])
}

model PostSave {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  profileId String  @db.ObjectId
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  postId String @db.ObjectId
  post   Post   @relation(fields: [postId], references: [id])

  @@unique([profileId, postId])
}

model PostComment {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  content    String?
  image      String?
  isArchived Boolean @default(false)

  profileId String  @db.ObjectId
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  postId String @db.ObjectId
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  parentCommentId String?      @db.ObjectId
  parentComment   PostComment? @relation("children", fields: [parentCommentId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  children PostComment[]     @relation("children")
  likes    PostCommentLike[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isArchived])
}

model PostCommentLike {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  profileId String  @db.ObjectId
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  postCommentId String      @db.ObjectId
  postComment   PostComment @relation(fields: [postCommentId], references: [id], onDelete: Cascade)

  @@unique([profileId, postCommentId])
}

model Group {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  ownerId String  @db.ObjectId
  owner   Profile @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  profiles ProfileGroup[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProfileGroup {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  profileId String  @db.ObjectId
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  groupId String @db.ObjectId
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([profileId, groupId])
}

model News {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  title       String
  content     String?
  type        NewsType
  cover       String
  isPublished Boolean  @default(true)

  schoolId String? @db.ObjectId
  school   School? @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  notifications NewsNotification[] @relation("notifications")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([title])
}

model NewsNotification {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  type   NewsType
  isRead Boolean

  studentId String  @db.ObjectId
  student   Student @relation("notifications", fields: [studentId], references: [id], onDelete: Cascade)

  fromId      String?  @db.ObjectId
  fromStudent Student? @relation("owns", fields: [fromId], references: [id], onDelete: Cascade)

  newsId String @db.ObjectId
  news   News   @relation("notifications", fields: [newsId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("Notification")
}

model StudentFollow {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  studentId String  @db.ObjectId
  student   Student @relation("follows", fields: [studentId], references: [id], onDelete: Cascade)

  followerId String  @db.ObjectId
  follower   Student @relation("followers", fields: [followerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, followerId])
}

model Contact {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  name    String
  title   ContactTitle
  phone   String
  email   String
  message String

  schoolId String? @db.ObjectId
  school   School? @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
